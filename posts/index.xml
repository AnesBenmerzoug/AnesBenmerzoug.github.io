<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Personal Blog</title>
<link>https://AnesBenmerzoug.github.io/posts/</link>
<atom:link href="https://AnesBenmerzoug.github.io/posts/index.xml" rel="self" type="application/rss+xml"/>
<description>This is Anes Benmerzoug&#39;s personal Blog.</description>
<generator>quarto-1.7.33</generator>
<lastBuildDate>Wed, 27 Aug 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>Measuring distance with a TF-Luna LiDAR and a Raspberry Pi</title>
  <dc:creator>Anes Benmerzoug</dc:creator>
  <link>https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-note callout-titled" title="EDIT 2025-08-29">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
EDIT 2025-08-29
</div>
</div>
<div class="callout-body-container callout-body">
<p>After publishing the original version of the post, I realized that the user manual I was using was out-of-date and that there was a <a href="https://en.benewake.com/DataDownload/index_pid_20_lcid_21.html">newer one available</a> on the Benewake website.</p>
<p>I have updated the post to reflect this.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The full code for this project/experiment can be found in the following repository: <a href="https://github.com/AnesBenmerzoug/rpi-tfluna-lidar">rpi-tfluna-lidar</a></p>
</div>
</div>
<p>I recently learned Rust and was looking to put it into practice by working on some cool side-projects. Since I work as an AI Engineer and have developed my fair share of chatbots, I first developed <a href="https://github.com/AnesBenmerzoug/pincer-chat">PincerChat</a> a few months ago, a desktop GUI for interacting with local LLMs served with Ollama. Looking back at it, I realize that I tried to chew more than I could swallow but nevertheless I learned a lot making it.</p>
<p>I then decided to try something simpler and at the same time get back into embedded systems and micro-controller development. During my master’s studies for Control Engineering in Algeria, a group of friends and I had our own team, called <em>OTO</em> which is a homonym for <em>Auto.</em> an abbreviation for <em>Automatique</em> (Automation in French), that built many different embedded projects like <a href="https://en.wikipedia.org/wiki/Ball_and_beam">a ball and beam system</a>, a ball and plate system and a <a href="https://en.wikipedia.org/wiki/Persistence_of_vision">persistence of vision</a> (PoV) display.</p>
<p>Before starting, I had to get some hardware. Luckily for me, I had a <a href="https://www.raspberrypi.com/products/raspberry-pi-3-model-b/">Raspberry Pi 3 model B</a> laying around that I was using as a Pi-Hole before moving into my current apartment and while browsing through AliExpress I stumbled upon the <a href="https://en.benewake.com/TFLuna/index.html">TF-Luna LiDAR</a>, a low cost LiDAR sensor and thought that I could use it to make a mobile robot that maps and navigates autonomously.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/raspberry_pi_with_tfluna.jpg" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Picture of TF-Luna connected to the Raspberry Pi</figcaption>
</figure>
</div>
<p>Unfortunately for me, once I received the TF-Luna and read its <a href="https://en.benewake.com/DataDownload/index_pid_20_lcid_21.html">user manual</a> I quickly realized that it is 1D LiDAR, i.e.&nbsp;that it only measures the distance to a single point, instead of being a 2D (distance and angle) or 3D (3D distance) LiDAR.</p>
<p>This is fine for a start, especially since I’m getting back into embedded systems after a long time but I will hopefully buy a better sensor in the future.</p>
<section id="tf-luna-and-distance-measurements-with-lidars" class="level1">
<h1>TF-Luna and distance measurements with LiDARS</h1>
<p>The <a href="https://en.benewake.com/TFLuna/index.html">TF-Luna</a> is a low-cost LiDAR distance sensor made by <a href="https://en.benewake.com/index.html">Benewake</a>, a LiDAR manufacturer based in Beijing, China.</p>
<p>LiDAR is an acronym of “Light Detection And Ranging”. It is a method for determining distances by targeting an object or a surface with a laser and measuring the time for the reflected light to return to the receiver. It is commonly used for creating detailed 3D maps and is effective in various applications, including autonomous vehicles and environmental monitoring.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/time_of_flight_wikipedia.svg" class="img-fluid figure-img"></p>
<figcaption>Basic time-of-flight principles applied to laser range-finding - <a href="https://en.wikipedia.org/wiki/Lidar">Wikipedia</a></figcaption>
</figure>
</div>
<p>A LiDAR determines the distance of an object or a surface with the formula:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AD%20=%20%5Cfrac%7Bc%20%5Ccdot%20t%7D%7B2%7D%0A"></p>
<p>where <strong>D</strong> is the distance between the sensor and the object or surface being measured, <strong>c</strong> is the speed of light, and <strong>t</strong> is the time spent for the laser light to travel to the object or surface being detected, then travel back to the sensor.</p>
<p>The TF-Luna however does not send a single pulse at a time, but rather periodically emits near infrared modulated waves and calculates the time by measuring the phase difference between the original wave and the reflected wave and uses that time to compute the relative distance of the object at which it is pointed.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/time_of_flight_tfluna.svg" class="img-fluid figure-img"></p>
<figcaption>Schematics of ToF Principle - <a href="https://files.seeedstudio.com/wiki/Grove-TF_Mini_LiDAR/res/SJ-PM-TF-Luna-A03-Product-Manual.pdf">TF-Luna user manual</a></figcaption>
</figure>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%0AD%20=%20%5Cfrac%7Bc%7D%7B2%7D%20%5Ccdot%20%5Cfrac%7B1%7D%7B2%5Cpi%20f%7D%20%5Ccdot%20%5CDelta%5Cvarphi%0A"></p>
<p>where <strong>D</strong> is the distance between the sensor and the object or surface being measured, <strong>c</strong> is the speed of light, and <strong>f</strong> is the frequency of the emitted signal, and <img src="https://latex.codecogs.com/png.latex?%5CDelta%5Cvarphi"> is the phase difference between emitted and received signal.</p>
<p>The device’s specifications can be seen in Table&nbsp;1.</p>
<div id="tbl-tfluna-parameters" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tfluna-parameters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Parameters specification of TF-Luna - <a href="https://en.benewake.com/DataDownload/index_pid_20_lcid_21.html">TF-Luna user manual</a>
</figcaption>
<div aria-describedby="tbl-tfluna-parameters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th>Description</th>
<th style="text-align: left;">Parameter value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Operating range</td>
<td style="text-align: left;">0.2 ~ 8m<sup>1</sup></td>
</tr>
<tr class="even">
<td>Accuracy</td>
<td style="text-align: left;"><ul>
<li>±6cm@ (0.2-3m)<sup>2</sup></li>
<li>±2%@ (3m-8m)</li>
</ul></td>
</tr>
<tr class="odd">
<td>Measurement unit</td>
<td style="text-align: left;">cm (Default)</td>
</tr>
<tr class="even">
<td>Range resolution</td>
<td style="text-align: left;">1cm</td>
</tr>
<tr class="odd">
<td>Field of View (FOV)</td>
<td style="text-align: left;">0.2°<sup>3</sup></td>
</tr>
<tr class="even">
<td>Framerate</td>
<td style="text-align: left;">1~250Hz<sup>4</sup> (100Hz default)</td>
</tr>
<tr class="odd">
<td>Weight</td>
<td style="text-align: left;">≤ 5g<sup>5</sup></td>
</tr>
<tr class="even">
<td>Power</td>
<td style="text-align: left;">≤ 0.35W<sup>6</sup></td>
</tr>
<tr class="odd">
<td>Dimensions</td>
<td style="text-align: left;">35mm x 21.25mm x 13.5mm<sup>7</sup></td>
</tr>
<tr class="even">
<td>Communication</td>
<td style="text-align: left;">I2C and UART<sup>8</sup></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="raspberry-pi-and-tf-luna" class="level1">
<h1>Raspberry Pi and TF-Luna</h1>
<p>I wired the TF-Luna to the Raspberry Pi as shown in Figure&nbsp;1 and Table&nbsp;2.</p>
<div id="fig-wiring" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-wiring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/wiring_diagram.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wiring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Wiring diagram made with <a href="https://app.cirkitdesigner.com">Cirkit Designer</a>
</figcaption>
</figure>
</div>
<div id="tbl-wiring" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-wiring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Raspberry Pi and TF-Luna Pin Wiring
</figcaption>
<div aria-describedby="tbl-wiring-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">TF-Luna Pin</th>
<th style="text-align: left;">Raspberry Pi Pin</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Pin 1 (+3.7-5.2V)</td>
<td style="text-align: left;">Pin 2 (5V)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pin 2 (RXD/SDA)</td>
<td style="text-align: left;">Pin 3 (GPIO 2 / SDA)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Pin 3 (TXD/SCL)</td>
<td style="text-align: left;">Pin 5 (GPIO 3 / SCL)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pin 4 (Gnd)</td>
<td style="text-align: left;">Pin 6 (Gnd)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Pin 5 (I2C Enable)</td>
<td style="text-align: left;">Pin 9 (Gnd)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pin 6 (Data Signal)</td>
<td style="text-align: left;">Not connected / used</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The TF-Luna supports both Serial (<a href="https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter">UART</a>) and <a href="https://en.wikipedia.org/wiki/I%C2%B2C">I2C</a> for communication. I decided to use I2C because I am planning to use more sensors and it allows multiplexing whereas UART is just used for point-to-point communication.</p>
<p>In order to enable I2C mode, we need to connect the TF-Luna’s 5th pin (I2C Enable) to ground.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re interested in using UART, please read this post instead <a href="https://makersportal.com/blog/distance-detection-with-the-tf-luna-lidar-and-raspberry-pi">Distance Detection with the TF-Luna LiDAR and Raspberry Pi - MakerPortal</a>.</p>
</div>
</div>
<p>Since there was, as of writing this post, no existing crate on <a href="https://crates.io">crates.io</a> for interacting with the TF-Luna, I had to write the code for that myself. Luckily for me, it turned out to be pretty straightforward thanks to the <a href="https://docs.rs/rppal/latest/rppal/">rppal</a> crate as well as these two sources:</p>
<ul>
<li>The <a href="https://files.seeedstudio.com/wiki/Grove-TF_Mini_LiDAR/res/SJ-PM-TF-Luna-A03-Product-Manual.pdf">TF-Luna user manual</a>.</li>
<li>The <a href="https://github.com/budryerson/TFLuna-I2C">TFLuna-I2C</a> Arduino library by budryerson.</li>
</ul>
<p>Once the wiring was done and the rppal crate added, all I had to do was figure out the correct register addresses from the user manual for reading the sensor measurements. This task should have been easy but it was made hard by the structure of the manual itself. Most of the pages are about the UART protocol and the different output format and only a few are about I2C and the registers.</p>
<p>I struggled at first to read measurements from the TF-Luna. I kept reading constant values no matter what I did ever I wrote <strong>0</strong> to the <strong>0x25</strong> register to enable it. It only worked after I decided randomly to try writing <strong>1</strong> instead. After investigating for a bit, I realized that I was using an <a href="https://files.seeedstudio.com/wiki/Grove-TF_Mini_LiDAR/res/SJ-PM-TF-Luna-A03-Product-Manual.pdf">older version</a> of the user manual (<code>A03</code> from 2020.3.15) instead of the newer version (<code>A05</code> from 2020.7.23).</p>
<p>In this newer version, the definition of I2C register <strong>0x25</strong> was changed so that to <strong>enable</strong> (respectively <strong>disable</strong>) the LiDAR sensor we have to set the <strong>0x25</strong> register to <strong>1</strong> (respectively <strong>0</strong>) instead of <strong>0</strong> (respectively <strong>1</strong>), see Figure&nbsp;2.</p>
<div id="fig-user-manual-error" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-user-manual-error-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/tfluna_user_manual_error.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-user-manual-error-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Excerpt from page 30 of TF-Luna user manual version <code>A03</code> showing values that were changed in version <code>A05</code>
</figcaption>
</figure>
</div>
</section>
<section id="raspberry-pi-and-rust" class="level1">
<h1>Raspberry Pi and Rust</h1>
<p>The Raspberry Pi 3 model B is not the most powerful computer there is and compiling the code on it could actually take too long, that’s why we cross-compile it on a separate, more powerful computer and then transfer the binary to it.</p>
<p>If you want to learn more about cross-compilation in general or specifically about cross-compilation for the Raspberry Pi, you should refer to the following links:</p>
<ul>
<li><a href="https://rustprojectprimer.com/building/cross.html">Cross-Compiling chapter from Rust Project Primer book</a></li>
<li><a href="https://rustmeup.com/using-rust-with-raspberry-pi">Using Rust with Raspberry Pi - RustMeUp</a></li>
</ul>
<p>The gist of it is to:</p>
<ul>
<li><p>Install the rustup target for the Raspberry Pi 3:</p>
<pre class="shell"><code>rustup target add aarch64-unknown-linux-gnu</code></pre>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The target may be different if you have a different Raspberry Pi model.</p>
</div>
</div></li>
<li><p>Install the cross-compiler (on Ubuntu, in this case):</p>
<pre class="shell"><code>sudo apt-get install gcc-multilib-arm-linux-gnueabihf</code></pre></li>
<li><p>Compile the code with the new install target:</p>
<pre class="shell"><code>cargo build --target aarch64-unknown-linux-gnu</code></pre>
<p>For the sake of simplicity, you should define this configuration inside <code>.cargo/config.toml</code> to avoid having to constantly pass the argument:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[target.aarch64-unknown-linux-gnu]</span></span>
<span id="cb4-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">linker</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aarch64-linux-gnu-gcc"</span></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[build]</span></span>
<span id="cb4-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">target</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aarch64-unknown-linux-gnu"</span></span></code></pre></div></li>
</ul>
<p>Once that’s done, then we have to copy the binary over to the Raspberry Pi and then execute it.</p>
<pre class="shell"><code>scp target/aarch64-unknown-linux-gnu/release/main raspberrypi:~Projects/main</code></pre>
<pre class="shell"><code>ssh raspberrypi ~/Projects/main</code></pre>
<p>In my repository, all of this can be done by simply calling <code>cargo run</code>.</p>
</section>
<section id="data-collection-and-visualization" class="level1">
<h1>Data Collection and Visualization</h1>
<p>For the data collection and visualization, we will use <a href="https://rerun.io/">rerun</a> which is an open-source log handling and visualization for spatial and embodied AI. The demos shown on their website definitely seem interesting.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/rerun_aria_dataset_explorer.png" class="img-fluid figure-img"></p>
<figcaption>Example screenshot of Aria Dataset Explorer using Rerun for visualization - <a href="https://rerun.io/">rerun.io</a></figcaption>
</figure>
</div>
<p>To use it we first start by adding the rerun crate as a dependency:</p>
<pre class="shell"><code>cargo add rerun</code></pre>
<p>It has quite a lot of features and will increase the size of the final binary, but I didn’t bother for now to go through them and determine which ones are absolutely necessary and which ones are not.</p>
<pre class="shell"><code>rerun</code></pre>
<pre class="shell"><code>cargo run --release</code></pre>
<p>I put the TF-Luna LiDAR on a table and pointed it at the ceiling, so the initial measurements are of the distance from the table to the ceiling which is about 2 meters (~200 cm).</p>
<p>I then moved my hand, relatively quickly, in front of it 4 times and that can be seen as the 4 shorts dips to a distance of about 21 centimeters. After that, I put my hand in front of it and left it there for a few seconds. I finally moved my hand away.</p>
<p>A 10Hz sampling frequency is not enough to detect fast movements, but it is more than enough for indoor autonomous navigation.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/rerun_screenshot.png" class="img-fluid figure-img"></p>
<figcaption>Screenshot of Rerun viewer showing recorded data</figcaption>
</figure>
</div>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Thanks to this projects, I have learned about using Rust on a Raspberry Pi and about dealing with not so intuitive sensor documents. It felt nice getting back into making projects like this after such a long time. It only took me a few days to get it working. It actually took me more time to write this post than to write the code itself.</p>
<p>As a next step, I would like to mount the TF-Luna on something that can be rotated with a servo or stepper motor in order to change the angle and be able to generate a 2D point cloud.</p>
<p>I have also decided to make a crate for interacting with the TF-Luna sensor (ideally with both async and embedded-hal support) hoping that it will be useful to others as well.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Operating range measured indoor based on a standard whiteboard with 90% reflectivity.↩︎</p></li>
<li id="fn2"><p>This is the theoretical value, the real value may be different.↩︎</p></li>
<li id="fn3"><p>This is the theoretical value, the real value may be different.↩︎</p></li>
<li id="fn4"><p>100Hz is the default value and only any factor (500/n, n can be any integer in [2, 500] e.g.&nbsp;250Hz, 125Hz) of 500Hz are available.↩︎</p></li>
<li id="fn5"><p>Taken from the <a href="https://en.benewake.com/TFLuna/index.html">TF-Luna’s product page</a>.↩︎</p></li>
<li id="fn6"><p>Taken from the <a href="https://en.benewake.com/TFLuna/index.html">TF-Luna’s product page</a>.↩︎</p></li>
<li id="fn7"><p>Taken from the <a href="https://en.benewake.com/TFLuna/index.html">TF-Luna’s product page</a>.↩︎</p></li>
<li id="fn8"><p>The choice between the two is made based on how the 5th pin is connected. Ground for I2C and 3.3V for UART.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section></div> ]]></description>
  <guid>https://AnesBenmerzoug.github.io/posts/rpi-tfluna-lidar/</guid>
  <pubDate>Wed, 27 Aug 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Using an LLM for information extraction</title>
  <dc:creator>Anes Benmerzoug</dc:creator>
  <link>https://AnesBenmerzoug.github.io/posts/llm-email-information-extaction/</link>
  <description><![CDATA[ 





<p>In this post we will see how to use a local LLM to extract structured information from emails.</p>
<p>When I joined appliedAI Initiative in 2021, my first project involved using AI to extract information from emails for a company that develops a document management system. At that time, LLMs were not as advanced as they are today, so we decided to train a custom model from scratch. However, we faced challenges, particularly because we did not have labeled data, and due to privacy restrictions, we couldn’t use the company’s customer data. As a result, we resorted to manually labeling emails from the <a href="https://www.cs.cmu.edu/~enron/">Enron dataset</a><sup>1</sup>.</p>
<p>Unfortunately, our approach yielded suboptimal results for several reasons, such as the mismatch between the Enron dataset and the actual customer emails and the lack of labeled training data. Today, however, extracting information from emails has become simpler than ever, and in this post, I want to demonstrate the improvements we can achieve with using LLMs.</p>
<section id="email-information-model" class="level1">
<h1>Email information model</h1>
<p>To start, we need define the model, and by extension the JSON schema, for the structured information we want to extract from the emails. For this, we use <a href="https://docs.pydantic.dev/latest/">Pydantic</a> to define models for email information, the sender, and the recipient, along with methods to compare and compute similarity scores.</p>
<div id="cell-4" class="cell" data-execution_count="2">
<details class="code-fold">
<summary><strong>EmailBaseModel</strong>: Base model class for email-related information extraction.</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> EmailBaseModel(BaseModel, extra<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"forbid"</span>):</span>
<span id="cb1-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Base model class for email-related information extraction.</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This class extends BaseModel and provides common functionality for comparing</span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    string attributes between email information objects.</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Note:</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        The extra="forbid" parameter ensures no additional attributes can be added</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        beyond those explicitly defined.</span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-11"></span>
<span id="cb1-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@staticmethod</span></span>
<span id="cb1-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _compare_strings(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb1-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Computes similarity ratio between two possibly None strings.</span></span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Uses SequenceMatcher to calculate string similarity when both inputs are</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        not missing (None). Handles cases where one or both inputs are None.</span></span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            a: First string to compare, or None</span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            b: Second string to compare, or None</span></span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Similarity ratio between 0.0 and 1.0, where:</span></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 1.0 indicates identical strings or both are None</span></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 0.0 indicates completely different strings or one of them is None</span></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - Values between 0.0 and 1.0 indicate partial similarity</span></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> b <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-30">            similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb1-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> b <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-32">            similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SequenceMatcher(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, a, b).ratio()</span>
<span id="cb1-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb1-34">            similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb1-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-36">            similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb1-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> similarity</span></code></pre></div>
</details>
</div>
<div id="cell-5" class="cell" data-execution_count="3">
<details class="code-fold">
<summary><strong>Sender</strong>: Represents a sender of an email with their associated information.</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Sender(EmailBaseModel):</span>
<span id="cb2-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Represents a sender of an email with their associated information.</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Stores and compares sender details including name, email, phone number,</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    role, and organization.</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Attributes:</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        name: The sender's full name if available</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        email: The sender's email address</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        phone_number: The sender's phone number if available</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        role: The sender's professional role if available</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        organization: The sender's organization if available</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb2-14"></span>
<span id="cb2-15">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb2-16">    email: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb2-17">    phone_number: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb2-18">    role: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb2-19">    organization: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb2-20"></span>
<span id="cb2-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> compare(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, other: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sender"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb2-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compares this sender with another sender object.</span></span>
<span id="cb2-23"></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Calculates similarity by comparing all attributes using string comparison</span></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        and returns the mean similarity across all fields.</span></span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            other: Another Sender object to compare against</span></span>
<span id="cb2-29"></span>
<span id="cb2-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb2-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Mean similarity ratio between 0.0 and 1.0, where:</span></span>
<span id="cb2-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 1.0 indicates identical senders</span></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 0.0 indicates completely different senders or invalid comparison</span></span>
<span id="cb2-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - Values between 0.0 and 1.0 indicate partial similarity across fields</span></span>
<span id="cb2-35"></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Note:</span></span>
<span id="cb2-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Returns 0.0 if other is not a Sender instance.</span></span>
<span id="cb2-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb2-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(other, Sender):</span>
<span id="cb2-40">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb2-41"></span>
<span id="cb2-42">        name_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, other.name)</span>
<span id="cb2-43">        email_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.email, other.email)</span>
<span id="cb2-44">        phone_number_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(</span>
<span id="cb2-45">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.phone_number, other.phone_number</span>
<span id="cb2-46">        )</span>
<span id="cb2-47">        role_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.role, other.role)</span>
<span id="cb2-48">        organization_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(</span>
<span id="cb2-49">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.organization, other.organization</span>
<span id="cb2-50">        )</span>
<span id="cb2-51">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fmean(</span>
<span id="cb2-52">            [</span>
<span id="cb2-53">                name_similarity,</span>
<span id="cb2-54">                email_similarity,</span>
<span id="cb2-55">                phone_number_similarity,</span>
<span id="cb2-56">                role_similarity,</span>
<span id="cb2-57">                organization_similarity,</span>
<span id="cb2-58">            ]</span>
<span id="cb2-59">        )</span></code></pre></div>
</details>
</div>
<div id="cell-6" class="cell" data-execution_count="4">
<details class="code-fold">
<summary><strong>Recipient</strong>: Represents a recipient of an email with their associated information.</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Recipient(EmailBaseModel):</span>
<span id="cb3-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Represents a recipient of an email with their associated information.</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Stores and compares recipient details including name, email, phone number,</span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    role, organization, and their type of recipiency (to, cc, bcc).</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Attributes:</span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        name: The recipient's full name if available</span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        email: The recipient's email address</span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        phone_number: The recipient's phone number if available</span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        role: The recipient's professional role if available</span></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        organization: The recipient's organization if available</span></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        type: The type of recipient ("to", "cc", or "bcc")</span></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-15"></span>
<span id="cb3-16">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb3-17">    email: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb3-18">    phone_number: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb3-19">    role: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb3-20">    organization: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb3-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span></span>
<span id="cb3-22"></span>
<span id="cb3-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> compare(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, other: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Recipient"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compares this recipient with another recipient object.</span></span>
<span id="cb3-25"></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Calculates similarity by comparing all attributes using string comparison</span></span>
<span id="cb3-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        and includes exact matching for recipient type. Returns the mean</span></span>
<span id="cb3-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        similarity across all fields.</span></span>
<span id="cb3-29"></span>
<span id="cb3-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb3-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            other: Another Recipient object to compare against</span></span>
<span id="cb3-32"></span>
<span id="cb3-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb3-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Mean similarity ratio between 0.0 and 1.0, where:</span></span>
<span id="cb3-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 1.0 indicates identical recipients</span></span>
<span id="cb3-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 0.0 indicates completely different recipients or invalid comparison</span></span>
<span id="cb3-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - Values between 0.0 and 1.0 indicate partial similarity across fields</span></span>
<span id="cb3-38"></span>
<span id="cb3-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Note:</span></span>
<span id="cb3-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Returns 0.0 if other is not a Recipient instance.</span></span>
<span id="cb3-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Recipient type comparison is binary: 1.0 if identical, 0.0 if different.</span></span>
<span id="cb3-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb3-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(other, Recipient):</span>
<span id="cb3-44">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb3-45"></span>
<span id="cb3-46">        name_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name, other.name)</span>
<span id="cb3-47">        email_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.email, other.email)</span>
<span id="cb3-48">        phone_number_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(</span>
<span id="cb3-49">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.phone_number, other.phone_number</span>
<span id="cb3-50">        )</span>
<span id="cb3-51">        role_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.role, other.role)</span>
<span id="cb3-52">        organization_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(</span>
<span id="cb3-53">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.organization, other.organization</span>
<span id="cb3-54">        )</span>
<span id="cb3-55">        type_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb3-56">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fmean(</span>
<span id="cb3-57">            [</span>
<span id="cb3-58">                name_similarity,</span>
<span id="cb3-59">                email_similarity,</span>
<span id="cb3-60">                phone_number_similarity,</span>
<span id="cb3-61">                role_similarity,</span>
<span id="cb3-62">                organization_similarity,</span>
<span id="cb3-63">                type_similarity,</span>
<span id="cb3-64">            ]</span>
<span id="cb3-65">        )</span></code></pre></div>
</details>
</div>
<div id="cell-7" class="cell" data-execution_count="5">
<details class="code-fold">
<summary><strong>EmailInformation</strong>: Represents information extracted from an email.</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> EmailInformation(EmailBaseModel):</span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Represents information extracted from an email.</span></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Stores and compares email metadata including date, subject, sender information,</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    and a list of recipients. Provides functionality to compare two email information</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    objects for similarity.</span></span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Attributes:</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        date: The date of the email</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        subject: The email subject line</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        sender: Sender object containing sender information</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        recipients: List of Recipient objects containing recipient information</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-14"></span>
<span id="cb4-15">    date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-16">    subject: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-17">    sender: Sender</span>
<span id="cb4-18">    recipients: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Recipient]</span>
<span id="cb4-19"></span>
<span id="cb4-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> compare(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, other: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EmailInformation"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb4-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compares this email information with another email information object.</span></span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Performs a detailed comparison of all email attributes including sender</span></span>
<span id="cb4-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        and recipient information. For recipients, finds the best matching recipient</span></span>
<span id="cb4-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        pairs between the two emails and averages their similarities.</span></span>
<span id="cb4-26"></span>
<span id="cb4-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb4-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            other: Another EmailInformation object to compare against</span></span>
<span id="cb4-29"></span>
<span id="cb4-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb4-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Mean similarity ratio between 0.0 and 1.0, where:</span></span>
<span id="cb4-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 1.0 indicates identical email information</span></span>
<span id="cb4-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - 0.0 indicates completely different emails or invalid comparison</span></span>
<span id="cb4-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - Values between 0.0 and 1.0 indicate partial similarity across all fields</span></span>
<span id="cb4-35"></span>
<span id="cb4-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Note:</span></span>
<span id="cb4-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - Returns 0.0 if other is not an EmailInformation instance.</span></span>
<span id="cb4-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - Returns 1.0 if self == other (exact match).</span></span>
<span id="cb4-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - Recipient comparison finds the best matching recipient for each</span></span>
<span id="cb4-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">              recipient in self.recipients among other.recipients.</span></span>
<span id="cb4-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb4-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(other, EmailInformation):</span>
<span id="cb4-43">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb4-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other:</span>
<span id="cb4-45">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb4-46">        date_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.date, other.date)</span>
<span id="cb4-47">        subject_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._compare_strings(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.subject, other.subject)</span>
<span id="cb4-48">        sender_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.sender.compare(other.sender)</span>
<span id="cb4-49"></span>
<span id="cb4-50">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.recipients <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> other.recipients:</span>
<span id="cb4-51">            recipient_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb4-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-53">            recipient_similarities <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb4-54">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> recipient_1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.recipients:</span>
<span id="cb4-55">                recipient_1_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb4-56">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> recipient_2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> other.recipients:</span>
<span id="cb4-57">                    recipient_1_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(</span>
<span id="cb4-58">                        recipient_1_similarity, recipient_1.compare(recipient_2)</span>
<span id="cb4-59">                    )</span>
<span id="cb4-60">                recipient_similarities.append(recipient_1_similarity)</span>
<span id="cb4-61">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> recipient_similarities:</span>
<span id="cb4-62">                recipient_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fmean(recipient_similarities)</span>
<span id="cb4-63">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-64">                recipient_similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb4-65"></span>
<span id="cb4-66">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fmean(</span>
<span id="cb4-67">            [</span>
<span id="cb4-68">                date_similarity,</span>
<span id="cb4-69">                subject_similarity,</span>
<span id="cb4-70">                sender_similarity,</span>
<span id="cb4-71">                recipient_similarity,</span>
<span id="cb4-72">            ]</span>
<span id="cb4-73">        )</span></code></pre></div>
</details>
</div>
<p>To evaluate our approaches, we define a helper function to run the extraction on all emails in a given dataset and compute similarities.</p>
<div id="cell-9" class="cell" data-execution_count="6">
<details class="code-fold">
<summary><strong>evaluate_extraction</strong>: Function that evaluates an email information extraction function against a ground truth dataset.</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_extraction(</span>
<span id="cb5-2">    extract_fn: Callable[[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>], EmailInformation],</span>
<span id="cb5-3">    dataset: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, Any]],</span>
<span id="cb5-4">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]:</span>
<span id="cb5-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Evaluates an email information extraction function against a ground truth dataset.</span></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Processes each email in the dataset using the provided extraction function and</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    compares the results against ground truth annotations using the EmailInformation</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    comparison logic.</span></span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        extract_fn: Function that takes a raw email string as input and returns</span></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            an EmailInformation object containing the extracted information.</span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        dataset: List of dictionaries, where each dictionary contains:</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - 'raw_email': The raw email text to process</span></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - 'extracted_information': Ground truth EmailInformation object</span></span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        List of similarity scores between 0.0 and 1.0 for each email, where:</span></span>
<span id="cb5-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - 1.0 indicates perfect extraction matching ground truth</span></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - 0.0 indicates completely incorrect extraction</span></span>
<span id="cb5-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - Values between indicate partial matching of extracted information</span></span>
<span id="cb5-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb5-24">    scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb5-25"></span>
<span id="cb5-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> sample <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(dataset, desc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Emails"</span>, leave<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb5-27">        extracted_information <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_fn(sample[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_email"</span>])</span>
<span id="cb5-28"></span>
<span id="cb5-29">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sample[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"extracted_information"</span>].compare(extracted_information)</span>
<span id="cb5-30">        scores.append(score)</span>
<span id="cb5-31"></span>
<span id="cb5-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> scores</span></code></pre></div>
</details>
</div>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<p>For this exercise, we use 20 emails from the <a href="https://www.cs.cmu.edu/~enron/">Enron dataset</a> that I labelled myself. We use 4 emails for the training set ( We will see later for what purpose we need such as set) and 16 emails for the test set.</p>
<p>Sample raw email:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Message-ID</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;23530825.1075858413552.JavaMail.evans@thyme&gt;</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Date</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Thu, 10 May 2001 05:08:00 -0700 (PDT)</span></span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">From</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kam.keiser@enron.com</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">To</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> sabra.dinari@enron.com</span></span>
<span id="cb6-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Subject</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> FP&amp;L</span></span>
<span id="cb6-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Cc</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> yuan.tian@enron.com, scott.neal@enron.com</span></span>
<span id="cb6-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Mime-Version</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb6-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Content-Type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> text/plain; charset=us-ascii</span></span>
<span id="cb6-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Content-Transfer-Encoding</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 7bit</span></span>
<span id="cb6-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Bcc</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> yuan.tian@enron.com, scott.neal@enron.com</span></span>
<span id="cb6-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">X-From</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Kam Keiser</span></span>
<span id="cb6-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">X-To</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Sabra L Dinari</span></span>
<span id="cb6-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">X-cc</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Yuan Tian, Scott Neal</span></span>
<span id="cb6-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">X-bcc</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">X-Folder</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> \Scott_Neal_Jun2001\Notes Folders\Notes inbox</span></span>
<span id="cb6-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">X-Origin</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Neal-S</span></span>
<span id="cb6-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">X-FileName</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> sneal.nsf</span></span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Sabra,</span></span>
<span id="cb6-20"></span>
<span id="cb6-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I have extended the current FP&amp;L sitara</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> #217969 to the end of the deal</span></span>
<span id="cb6-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(2/2010).</span></span>
<span id="cb6-23"></span>
<span id="cb6-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Keeping the same deal</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # helps us keep up with the value.</span></span>
<span id="cb6-25"></span>
<span id="cb6-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I set it up with the volumes we booked in TAGG, I know the volumes and</span></span>
<span id="cb6-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">locations will change but if you could send me and Yuan an e-mail when you</span></span>
<span id="cb6-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">have made your change during bid week we will make the changes to the hedge</span></span>
<span id="cb6-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">deal.</span></span>
<span id="cb6-30"></span>
<span id="cb6-31"></span>
<span id="cb6-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Thanks,</span></span>
<span id="cb6-33"></span>
<span id="cb6-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Kam</span></span>
<span id="cb6-35"></span>
<span id="cb6-36"></span>
<span id="cb6-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ps.  Scott, you will not see any problems with this deal in the future.</span></span>
<span id="cb6-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Sorry for the trouble.</span></span></code></pre></div>
<p>Sample ground truth extracted information:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"date"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10.05.2001"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"subject"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FP&amp;L"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sender"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kam Keiser"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-6">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kam.keiser@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-7">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-8">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron Corp."</span></span>
<span id="cb7-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb7-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"recipients"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb7-12">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-13">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sabra L. Dinari"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-14">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sabra.dinari@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-15">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-16">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-17">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron Corp."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-18">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span></span>
<span id="cb7-19">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-20">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-21">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scott Neal"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-22">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scott.neal@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-23">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-24">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-25">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron Corp."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-26">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb7-27">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-28">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-29">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scott Neal"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-30">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scott.neal@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-31">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron Corp."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span></span>
<span id="cb7-35">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-36">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-37">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yuan Tian"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-38">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yuan.tian@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-39">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-41">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron Corp."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-42">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb7-43">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-44">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-45">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yuan Tian"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-46">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yuan.tian@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-47">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-48">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-49">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron Corp."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-50">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span></span>
<span id="cb7-51">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-52">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-53"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
</section>
<section id="approaches" class="level1">
<h1>Approaches</h1>
<section id="baseline---use-pythons-builtin-email-parser" class="level2">
<h2 class="anchored" data-anchor-id="baseline---use-pythons-builtin-email-parser">Baseline - Use Python’s builtin email parser</h2>
<p>As a baseline, we use Python’s built-in email parser from the <a href="https://docs.python.org/3/library/email.examples.html">email</a> package to extract information. We define an extraction function that parses the emails and extracts basic information without much validation.</p>
<div id="cell-17" class="cell" data-execution_count="11">
<details class="code-fold">
<summary><strong>extract_information_with_builtin_parser</strong>: Function that extracts information using Python’s built-in email parser.</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_information_with_builtin_parser(raw_email: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> EmailInformation:</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Extracts structured information from a raw email using Python's built-in email parser.</span></span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parses the raw email text to extract metadata including date, subject, sender, and recipients.</span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Handles special X-headers for additional information like sender and recipient names.</span></span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        raw_email: Raw email text including headers and body.</span></span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Structured object containing the extracted information with:</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - date: Formatted as DD.MM.YYYY</span></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - subject: Email subject line</span></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - sender: Sender information including email and optional name</span></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - recipients: List of recipients (to/cc/bcc) with email and optional name,</span></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                sorted by email address</span></span>
<span id="cb8-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb8-18">    parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Parser()</span>
<span id="cb8-19">    email <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.parsestr(raw_email)</span>
<span id="cb8-20">    parsed_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.strptime(</span>
<span id="cb8-21">        email[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>].strip().split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"("</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%a, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> %b %Y %H:%M:%S %z "</span></span>
<span id="cb8-22">    )</span>
<span id="cb8-23">    formatted_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parsed_date.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.%m.%Y"</span>)</span>
<span id="cb8-24">    email_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>: formatted_date, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subject"</span>: email[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subject"</span>].strip()}</span>
<span id="cb8-25">    sender <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"email"</span>: email[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"from"</span>].strip()}</span>
<span id="cb8-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> email[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-from"</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> email[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-from"</span>].strip() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> email[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"from"</span>]:</span>
<span id="cb8-27">        sender[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> email[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-from"</span>].strip()</span>
<span id="cb8-28">    email_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sender"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sender</span>
<span id="cb8-29"></span>
<span id="cb8-30">    recipients <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb8-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> type_ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span>]:</span>
<span id="cb8-32">        recipient_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> email.get(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"X-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>type_<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>).strip().split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>)</span>
<span id="cb8-33">        recipient_emails <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> email.get(type_, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb8-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> recipient_emails <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-35">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb8-36">        recipient_emails <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> recipient_emails.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>)</span>
<span id="cb8-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(recipient_emails) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(recipient_names):</span>
<span id="cb8-38">            recipient_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(recipient_emails)</span>
<span id="cb8-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> recipient_name, recipient_email <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(recipient_names, recipient_emails):</span>
<span id="cb8-40">            recipient <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: type_, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"email"</span>: recipient_email.strip()}</span>
<span id="cb8-41">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> recipient_name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> recipient_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> recipient_email:</span>
<span id="cb8-42">                recipient[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> recipient_name.strip()</span>
<span id="cb8-43">            recipients.append(recipient)</span>
<span id="cb8-44"></span>
<span id="cb8-45">    email_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"recipients"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(recipients, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"email"</span>]))</span>
<span id="cb8-46"></span>
<span id="cb8-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> EmailInformation.model_validate(email_dict)</span></code></pre></div>
</details>
</div>
<div id="cell-18" class="cell" data-execution_count="12">
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"41da426371b14a06adc8c9056c56ead0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Using this method, we extract the following information from the sample test email:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"date"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10.05.2001"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"subject"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FP&amp;L"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sender"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kam Keiser"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-6">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kam.keiser@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-7">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-8">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span></span>
<span id="cb9-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb9-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"recipients"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb9-12">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-13">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sabra L Dinari"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-14">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sabra.dinari@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-15">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-16">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-17">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-18">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span></span>
<span id="cb9-19">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-20">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-21">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scott Neal"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-22">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scott.neal@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-23">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-24">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-25">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-26">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb9-27">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-28">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-29">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-30">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scott.neal@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-31">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span></span>
<span id="cb9-35">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-36">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-37">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yuan Tian"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-38">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yuan.tian@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-39">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-41">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-42">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb9-43">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-44">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-45">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-46">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yuan.tian@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-47">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-48">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-49">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-50">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span></span>
<span id="cb9-51">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb9-52">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb9-53"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
<p>We also compute the average score of this approach on the test set:</p>
<p>84.29%</p>
<p>The results are plotted as a box plot, showing that while the extraction is relatively good, it is far from perfect.</p>
<div id="cell-24" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/llm-email-information-extaction/index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img" alt="Builtin Email Parser Score"></p>
<figcaption>Builtin Email Parser Score</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="first-approach---use-llm-zero-shot-extraction-with-json-schema" class="level2">
<h2 class="anchored" data-anchor-id="first-approach---use-llm-zero-shot-extraction-with-json-schema">First Approach - Use LLM zero-shot extraction with JSON schema</h2>
<p>Next, we explore using an LLM for zero-shot extraction with a JSON schema. For this, we use <a href="https://llama-cpp-python.readthedocs.io/en/latest/">llama-cpp-python</a>, a Python wrapper for <a href="https://github.com/ggerganov/llama.cpp">llama.cpp</a>, to run a local LLM. This approach allows us to pass a JSON schema, ensuring structured output without needing to adjust the prompt repeatedly in order to coerce the LLM into generating valid JSON data.</p>
<blockquote class="blockquote">
<p><strong>Note</strong>: There are <a href="https://github.com/ggerganov/llama.cpp/blob/master/grammars/README.md#troubleshooting">known performance issues</a> with llama.cpp’s structured output generation using grammars and, by extension, json schemas especially with nested objects.</p>
</blockquote>
<p>We use a quantized version of Llama 3.2 3B Instruct with a context length of 16,384 tokens to handle long raw emails.</p>
<div id="cell-26" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Llama.from_pretrained(</span>
<span id="cb10-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bartowski/Llama-3.2-3B-Instruct-GGUF"</span>,</span>
<span id="cb10-3">    filename<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Llama-3.2-3B-Instruct-Q8_0.gguf"</span>,</span>
<span id="cb10-4">    n_ctx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16384</span>,</span>
<span id="cb10-5">    n_gpu_layers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb10-6">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb10-7">)</span></code></pre></div>
</div>
<p>A system prompt is defined to guide the LLM, using a JSON type definition instead of a JSON schema, inspired by a blog post I came across. This version is shorter, produces better results, and is more human-readable.</p>
<p>We then define a system prompt to guide the LLM, using a JSON type definition instead of a JSON schema, inspired by <a href="https://www.boundaryml.com/blog/type-definition-prompting-baml">this blog post</a> I came accross. The prompt with the type definition is shorter, produces better results and is more human-readable.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb11-1"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">You</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">are</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">a</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">helpful</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">assistant</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">that</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">extract</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">information</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">from</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">a</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">user</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">provided</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">in</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">JSON</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">format</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">that</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">adheres</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">to</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">the</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">following</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">schema:</span></span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"date"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"subject"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sender"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-7">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-8">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-10">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-11">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span></span>
<span id="cb11-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb11-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"recipients"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb11-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-16">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-17">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-18">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-19">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">enum(</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb11-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[]</span></span>
<span id="cb11-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<div id="cell-29" class="cell" data-execution_count="18">
<details class="code-fold">
<summary><strong>extract_information_with_llm</strong>: Function that extracts information using an LLM</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_information_with_llm(</span>
<span id="cb12-2">    raw_email: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>, system_prompt: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb12-3">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> EmailInformation:</span>
<span id="cb12-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Extracts structured information from a raw email using an LLM.</span></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Uses chat completion API to parse email content into structured format.</span></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Enforces output schema validation using EmailInformation model specification.</span></span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        raw_email: Raw email text including headers and body.</span></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        system_prompt: System prompt for the LLM that defines the extraction task.</span></span>
<span id="cb12-12"></span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb12-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Structured object containing the extracted information, validated against the EmailInformation schema.</span></span>
<span id="cb12-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb12-16">    response_format <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb12-17">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json_object"</span>,</span>
<span id="cb12-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"schema"</span>: EmailInformation.model_json_schema(),</span>
<span id="cb12-19">    }</span>
<span id="cb12-20">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm.create_chat_completion_openai_v1(</span>
<span id="cb12-21">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb12-22">            {</span>
<span id="cb12-23">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb12-24">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: system_prompt,</span>
<span id="cb12-25">            },</span>
<span id="cb12-26">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: raw_email},</span>
<span id="cb12-27">        ],</span>
<span id="cb12-28">        response_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>response_format,</span>
<span id="cb12-29">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,</span>
<span id="cb12-30">    )</span>
<span id="cb12-31">    extracted_information <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EmailInformation.model_validate_json(</span>
<span id="cb12-32">        output.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb12-33">    )</span>
<span id="cb12-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> extracted_information</span></code></pre></div>
</details>
</div>
<div id="cell-30" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3ddc1435e0c143af99317607e6ff28a6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Using this method, we extract the following information from the sample test email:</p>
<p>Sample extracted information with llm zero-shot prompt:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"date"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Thu, 10 May 2001 05:08:00 -0700 (PDT)"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"subject"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FP&amp;L"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sender"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kam Keiser"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-6">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kam.keiser@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-7">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-8">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-From"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Origin: Neal-S"</span></span>
<span id="cb13-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb13-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"recipients"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb13-12">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-13">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sabra L Dinari"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-14">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sabra.dinari@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-15">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-16">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-To"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-17">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Origin: Neal-S"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-18">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span></span>
<span id="cb13-19">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-20">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-21">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yuan Tian"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-22">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yuan.tian@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-23">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-24">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-cc"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-25">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Origin: Neal-S"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-26">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb13-27">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-28">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb13-29">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scott Neal"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-30">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scott.neal@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-31">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-cc"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X-Origin: Neal-S"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb13-35">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-36">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb13-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
<p>We also compute the average score of this approach on the test set:</p>
<p>64.55%</p>
<div id="cell-35" class="cell" data-execution_count="22">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/llm-email-information-extaction/index_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img" alt="LLM Zero-Shot Prompt Score"></p>
<figcaption>LLM Zero-Shot Prompt Score</figcaption>
</figure>
</div>
</div>
</div>
<p>We can see that this approach performs much worse than the previous one, most likely due to mismatch in expected formats. For example, we expected the date to be of the form <code>11.07.2001</code> instead of <code>11/07/2001</code>, <code>11 Jul 2001</code> or <code>Wed, 11 Jul 2001</code>.</p>
<p>To fix that, we will provide an example of information extraction in the system prompt in order to better guide the LLM.</p>
</section>
<section id="second-approach---llm-few-shot-extraction-with-json-schema" class="level2">
<h2 class="anchored" data-anchor-id="second-approach---llm-few-shot-extraction-with-json-schema">Second approach - LLM few-shot extraction with JSON schema</h2>
<p>To improve performance, we move to a few-shot approach. Given context length and performance constraints, we use one example from the training set in the system prompt, making it a one-shot prompt approach.</p>
<p>We evaluate the impact of each example from the training set on the remaining examples in the training set to determine which one best improves the information extraction.</p>
<div id="cell-38" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">score_improvements <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> trange(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(train_set), desc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example"</span>):</span>
<span id="cb14-4">    example <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_set[i]</span>
<span id="cb14-5">    train_set_without_example <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_set[:i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> train_set[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> :]</span>
<span id="cb14-6"></span>
<span id="cb14-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We first compute the similarity with the zero-shot system prompt</span></span>
<span id="cb14-8">    scores_zero_shot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluate_extraction(</span>
<span id="cb14-9">        partial(extract_information_with_llm, system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_prompt),</span>
<span id="cb14-10">        train_set_without_example,</span>
<span id="cb14-11">    )</span>
<span id="cb14-12">    mean_score_zero_shot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.mean(scores_zero_shot).item()</span>
<span id="cb14-13"></span>
<span id="cb14-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We then compute the similarity with the one-shot (with example) system prompt</span></span>
<span id="cb14-15">    system_prompt_with_example <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb14-16">        system_prompt</span>
<span id="cb14-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span></span>
<span id="cb14-18"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Use the following example of raw email and extracted information as reference:</span></span>
<span id="cb14-19"></span>
<span id="cb14-20"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"># Raw email</span></span>
<span id="cb14-21"></span>
<span id="cb14-22"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>example[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_email"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-23"></span>
<span id="cb14-24"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"># Extracted information</span></span>
<span id="cb14-25"></span>
<span id="cb14-26"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>example[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"extracted_information"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>model_dump_json(indent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-27"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb14-28">    )</span>
<span id="cb14-29">    scores_one_shot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluate_extraction(</span>
<span id="cb14-30">        partial(extract_information_with_llm, system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_prompt_with_example),</span>
<span id="cb14-31">        train_set_without_example,</span>
<span id="cb14-32">    )</span>
<span id="cb14-33">    mean_score_one_shot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.mean(scores_one_shot).item()</span>
<span id="cb14-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We then compute the difference in similarity</span></span>
<span id="cb14-35">    score_improvement <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mean_score_one_shot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean_score_zero_shot</span>
<span id="cb14-36">    score_improvements.append(</span>
<span id="cb14-37">        (</span>
<span id="cb14-38">            score_improvement,</span>
<span id="cb14-39">            system_prompt_with_example,</span>
<span id="cb14-40">        )</span>
<span id="cb14-41">    )</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"df55d51eae17478f80733b0b27bb0196","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6074e38a694846a18931bccc6a5446eb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"04a6232fe3344405b08f756201d0ec73","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"93d029a2234d49dd8db2a52041398a43","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"abaae7fd0ac94900a7670138fa95f633","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3e4dbe896e5048b7bd41da8f063ca3aa","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1ffe8106c0024d44a5e68e0e37b42789","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"78ab20dcc3124218a29844705f761d09","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8b6aa09a4d334c43bba3c56c946a93a2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="45">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/llm-email-information-extaction/index_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img" alt="LLM One-Shot Prompt Score Improvement"></p>
<figcaption>LLM One-Shot Prompt Score Improvement</figcaption>
</figure>
</div>
</div>
</div>
<p>The best score improvement we can obtain using the one-shot prompt and out small train set is: 31.45</p>
<p>The system prompt and, by extension, example corresponding to this improvement are:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb15-1"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">You</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">are</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">a</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">helpful</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">assistant</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">that</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">extract</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">information</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">from</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">a</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">user</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">provided</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">in</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">JSON</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">format</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">that</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">adheres</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">to</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">the</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">following</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">schema:</span></span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"date"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"subject"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sender"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-7">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-8">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-10">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-11">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span></span>
<span id="cb15-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb15-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"recipients"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-16">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-17">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-18">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-19">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"to"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">enum(</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcc"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb15-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[]</span></span>
<span id="cb15-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-22"></span>
<span id="cb15-23"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Use</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">the</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">following</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">example</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">of</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">raw</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">and</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">extracted</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">information</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">as</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">reference:</span></span>
<span id="cb15-24"></span>
<span id="cb15-25"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">#</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Raw</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span></span>
<span id="cb15-26"></span>
<span id="cb15-27"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Message-ID:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;7555575.1075857946274.JavaMail.evans@thyme&gt;</span></span>
<span id="cb15-28"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Date:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Mon,</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Apr</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">2001</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">11:17:00</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">-0700</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(PDT)</span></span>
<span id="cb15-29"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">From:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">cathy@pira.com</span></span>
<span id="cb15-30"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">To:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">greg@pira.com</span></span>
<span id="cb15-31"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Subject:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">PIRA's</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Special</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Release</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Gas</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Flash:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Strong</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Supply</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Growth</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Indicated</span></span>
<span id="cb15-32"> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">04/30/01</span></span>
<span id="cb15-33"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Mime-Version:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb15-34"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Content-Type:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">text/plain;</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">charset=us-ascii</span></span>
<span id="cb15-35"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Content-Transfer-Encoding:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">7bit</span></span>
<span id="cb15-36"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">X-From:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Cathy</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Lopez"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;cathy@pira.com&gt;</span></span>
<span id="cb15-37"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">X-To:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"PIRA</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Natural</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Gas</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Retainer</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Client"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;greg@pira.com&gt;</span></span>
<span id="cb15-38"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">X-cc:</span></span>
<span id="cb15-39"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">X-bcc:</span></span>
<span id="cb15-40"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">X-Folder:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\Lawrence_May_Jun2001_1\Notes</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Folders\Notes</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">inbox</span></span>
<span id="cb15-41"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">X-Origin:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">May-L</span></span>
<span id="cb15-42"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">X-FileName:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">lmay2.nsf</span></span>
<span id="cb15-43"></span>
<span id="cb15-44"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Attached</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">is</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">a</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">PIRA</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Special</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Release</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">entitled</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Gas</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Flash:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Strong</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Supply</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Growth</span></span>
<span id="cb15-45"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Indicated."</span></span>
<span id="cb15-46"></span>
<span id="cb15-47"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">If</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">you</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">have</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">any</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">questions</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">regarding</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">the</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">report's</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">content,</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">please</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">contact:</span></span>
<span id="cb15-48"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Greg</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Shuttlesworth</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(email:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">greg@pira.com),</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Tom</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Howard</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(email:</span></span>
<span id="cb15-49"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">tazh@pira.com),</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Richard</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Redash</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(email:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Rich@pira.com),</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Nobu</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Tarui</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(email:</span></span>
<span id="cb15-50"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">nobuo@pira.com)</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">or</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Jane</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Hsu</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(email:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">jane@pira.com),</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">at</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(212)</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">686-6808.</span></span>
<span id="cb15-51"></span>
<span id="cb15-52"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Contact</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">John</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Graziano</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">regarding</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">PIRA</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">report</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">distribution</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">and</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">address</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">changes</span></span>
<span id="cb15-53"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">at</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(212)</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">686-6808,</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">email:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">support@pira.com.</span></span>
<span id="cb15-54"></span>
<span id="cb15-55"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Circulation</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">of</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">the</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Gas</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Flash</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Weekly"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">outside</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">a</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Client's</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">licensed</span></span>
<span id="cb15-56"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">distribution</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">area</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">is</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">strictly</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">prohibited.</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Clients</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">that</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">are</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsure</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">of</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">their</span></span>
<span id="cb15-57"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">licensed</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">distribution</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">or</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">an</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">extension</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">of</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">their</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">current</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">license</span></span>
<span id="cb15-58"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">should</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">contact</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">their</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">PIRA</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">sales</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">representative,</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">or</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">to</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">sales@pira.com.</span></span>
<span id="cb15-59"></span>
<span id="cb15-60"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">PIRA</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Energy</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Group</span></span>
<span id="cb15-61"></span>
<span id="cb15-62"></span>
<span id="cb15-63"></span>
<span id="cb15-64"></span>
<span id="cb15-65"> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">-</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">agaspec043001.pdf</span></span>
<span id="cb15-66"></span>
<span id="cb15-67"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">#</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">Extracted</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">information</span></span>
<span id="cb15-68"></span>
<span id="cb15-69"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-70">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"date"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30.04.2001"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-71">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"subject"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PIRA's Special Release Gas Flash: Strong Supply Growth Indicated 04/30/01"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-72">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sender"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-73">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cathy Lopez"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-74">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cathy@pira.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-75">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-76">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-77">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PIRA Energy Group"</span></span>
<span id="cb15-78">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb15-79">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"recipients"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb15-80">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-81">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Greg Shuttlesworth"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-82">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"greg@pira.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-83">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-84">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-85">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PIRA Energy Group"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb15-86">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span></span>
<span id="cb15-87">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-88">  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb15-89"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<div id="cell-42" class="cell" data-execution_count="46">
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"39a798a7095a4c1fa75a9853b166b0ba","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Using this method, we extract the following information from the sample test email:</p>
<p>Sample extracted information with llm one-shot prompt:</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"date"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10.05.2001"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"subject"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FP&amp;L"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"sender"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-5">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kam Keiser"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-6">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kam.keiser@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-7">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-8">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-9">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron"</span></span>
<span id="cb16-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb16-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"recipients"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb16-12">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-13">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sabra L Dinari"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-14">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sabra.dinari@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-15">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-16">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-17">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-18">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"to"</span></span>
<span id="cb16-19">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-20">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-21">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yuan Tian"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-22">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yuan.tian@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-23">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-24">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-25">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-26">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb16-27">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-28">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb16-29">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scott Neal"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-30">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scott.neal@enron.com"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-31">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"phone_number"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"role"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">null</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"organization"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Enron"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb16-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cc"</span></span>
<span id="cb16-35">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-36">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb16-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
<p>The average score of this second approach on the test set is:</p>
<p>87.27%</p>
<div id="cell-47" class="cell" data-execution_count="49">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/llm-email-information-extaction/index_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img" alt="LLM One-Shot Prompt Score"></p>
<figcaption>LLM One-Shot Prompt Score</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-of-the-3-approaches" class="level2">
<h2 class="anchored" data-anchor-id="comparison-of-the-3-approaches">Comparison of the 3 approaches</h2>
<p>When comparing the scores of the three approaches, it is clear that both the baseline parser and the few-shot approach outperform the zero-shot approach. The few-shot approach is more flexible and generalizes better, which could prove beneficial when scaling to larger datasets.</p>
<div id="cell-49" class="cell" data-execution_count="50">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://AnesBenmerzoug.github.io/posts/llm-email-information-extaction/index_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img" alt="LLM One-Shot Prompt Score"></p>
<figcaption>LLM One-Shot Prompt Score</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>In this post, we have seen how a local LLM can be used to extract structured information from emails, provided you have access to the email content and the necessary permissions. We also explored how adding an example to the system prompt (few-shot prompting) can significantly improve the extraction.</p>
<p>This post is intended as a demonstration of how structured information extraction can be done with modern LLMs. For real-world applications, however, you would likely face additional constraints, such as more complex datasets, stricter privacy considerations, and the need for larger datasets to improve accuracy and robustness.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Enron Corporation was an American energy, commodities, and services that went bankrupt in 2001 after ascandal involving a corporate fraud case. The Enron Email Dataset, containing 500,000 internal emails, provides valuable insights into the company’s operations and is widely used for research in text mining and network analysis.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section></div> ]]></description>
  <guid>https://AnesBenmerzoug.github.io/posts/llm-email-information-extaction/</guid>
  <pubDate>Wed, 11 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Poetry and Python Versions</title>
  <dc:creator>Anes Benmerzoug</dc:creator>
  <link>https://AnesBenmerzoug.github.io/posts/poetry-and-python-versions/</link>
  <description><![CDATA[ 





<p>After a long pause of more than 4 years, I have finally decided to come back to my personal blog and start writing again.</p>
<p>For this first post in a long while, I wanted to do something simple: benchmark the performance of <a href="https://python-poetry.org/">Poetry</a> the python package manager when using different Python versions. The idea came to me after I saw that Python 3.13 was released with experimental <a href="https://docs.python.org/3/howto/free-threading-python.html">free threading</a> support where the <a href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">global interpreter lock (GIL)</a> is disabled.</p>
<p>As a daily user of Poetry either for work or for personal projects, I was curious to see whether its performance changes significantly based on the Python version used. To answer this question, I decided to take inspiration from the <a href="https://github.com/lincolnloop/python-package-manager-shootout">python-package-manager-shootout</a> repository, which benchmarks different Python package managers using a fixed Python version.</p>
<blockquote class="blockquote">
<p>Unfortunately, as of writing this blog post Poetry can’t installed be directly from PyPI using Pyhton 3.13 with the GIL disabled due to an issue with some of its dependencies, namely msgpack and cryptography. once that’s resolved, I will try to update this post or write another one.</p>
</blockquote>
<p>The remainder of this post is structured as follows:</p>
<ul>
<li>we will briefly see how to install the new Python version with free threading enabled,</li>
<li>then, we will describe the different operations as well as the setup that will used in the benchmarks</li>
<li>finally, we will visually analyze the result of the benchmarks.</li>
</ul>
<blockquote class="blockquote">
<p><strong>Disclaimer</strong> This experiment has several limitations that should be considered when interpreting the results. Firstly, we’re only testing with a limited set of Python versions (namely 3.11, 3.12, and 3.13). Additionaly, we’re using a fixed set of packages (Sentry’s <code>requirements.txt</code> file) to test Poetry’s performance. Both of these choices may not capture the full range of use cases and scenarios that Poetry may encounter in real-world use cases.</p>
</blockquote>
<section id="installation" class="level1">
<h1>Installation</h1>
<p>We will now see how to install Python 3.13 version with and without free threading using <a href="https://github.com/pyenv/pyenv">pyenv</a>, a popular tool for managing multiple Python versions.</p>
<p>Let’s first start by listing all available python versions for installation:</p>
<pre class="shell"><code>pyenv install -l</code></pre>
<p>The result should look something like:</p>
<pre class="shell"><code>Available versions:
  2.1.3
  2.2.3
  2.3.7
  ...
  ...
  3.13.0
  3.13.0t
  ...
  ...</code></pre>
<p>If you don’t see python 3.13 listed, it probably means that you need to update pyenv to the latest version using:</p>
<pre class="shell"><code>pyenv update</code></pre>
<p>To install Python 3.13 with free threading disabled (i.e.&nbsp;GIL enabled), you would use:</p>
<pre class="shell"><code>pyenv install 3.13.0</code></pre>
<p>To install Python 3.13 with free threading enabled (e.g.&nbsp;GIL disabled), you would use:</p>
<pre class="shell"><code>pyenv install 3.13.0t</code></pre>
<p>To test whether this worked, you would use:</p>
<pre class="shell"><code>python -VV</code></pre>
<p>The output should contain “experimental free-threading build” for the latter and not for the former.</p>
<p>For more detailed instructions and explanations, please refer to <a href="https://realpython.com/python313-free-threading-jit/">this blog post</a> from <a href="https://realpython.com">realpython.com</a></p>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p>To benchmark Poetry’s performance, I used the latest version of Poetry (version 1.8.4 as of writing this blog post) with a few different Python versions: 3.11, 3.12 and 3.13</p>
<p>All the files related to this blog post can be found in <a href="https://github.com/AnesBenmerzoug/poetry-python-benchmark">this repository</a>. It is heavily inspired by the <a href="https://github.com/lincolnloop/python-package-manager-shootout">python-package-manager-shootout</a> repository.</p>
<p>Similarly to that repository, we use a list of packages from a fixed version of <a href="https://github.com/getsentry/sentry/blob/da11f63098ef5c661e879effb8688178bb5eccee/requirements-base.txt">Sentry’s <code>requirements.txt</code> file</a> which was chosen arbitrarily as a non-trivial real-world example.</p>
<p>Unlike in <a href="https://lincolnloop.github.io/python-package-manager-shootout/">python-package-manager-shootout</a>, we use a newer version of Sentry’s requirements to avoid any issues during package installation with newer Python versions. Additionally, we use <a href="https://github.com/sharkdp/hyperfine">hyperfine</a>, a command-line benchmarking tool, to handle the execution and timing of each operation.</p>
<p>I benchmarked the following operations:</p>
<ul>
<li><code>import</code>: For this operation, we call <code>poetry add --lock --no-cache</code> to import all of the requirements in Sentry’s requirements.txt file into a newly initialized pyproject.toml file (We use Poetry’s <code>--lock</code> flag to prevent it from installing packages at this point).</li>
<li><code>lock</code>: For this operation, we call <code>poetry lock</code> both with and without the <code>--no-cache</code>. We delete the <code>poetry.lock</code> before every call to make sure the lock creation starts from scratch each time.</li>
<li><code>install</code>: For this operation, we call <code>poetry install</code> both with and without the <code>--no-cache</code>. We delete the created virtual environment before every call to make sure the installation starts from scratch each time.</li>
<li><code>update</code>: For this operation, we call <code>poetry update</code> both with and without the <code>--no-cache</code>. We delete the <code>poetry.lock</code> and restore it before every call to make sure the update starts from the same point each time.</li>
<li><code>add package</code>: For this operation, we call <code>poetry add numpy --no-cache</code>. We remove the <code>numpy</code> package after every call to make sure adding the package starts from the same point each time.</li>
</ul>
<blockquote class="blockquote">
<p>The <code>--no-cache</code> flag is used to tell poetry to ignore its own cache stored, by default on Linux, under <code>~/.cache/pypoetry/cache</code>.</p>
</blockquote>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p>I ran the benchmarks in CI to have a more or less consistent environment. The workflow runs the operations, collects and combines the results and then creates plots based on them.</p>
<p>The results and plots can be found as artifacts of the repository’s <a href="https://github.com/AnesBenmerzoug/poetry-python-benchmark/actions">benchmark CI workflow</a>. The plots used in this post come from <a href="https://github.com/AnesBenmerzoug/poetry-python-benchmark/actions/runs/11463804221">this specific workflow</a>, from the <a href="https://github.com/AnesBenmerzoug/poetry-python-benchmark/actions/runs/11463804221/artifacts/2089086106">benchmark-plots</a> artifact.</p>
<p>In Figure&nbsp;1, we can see that poetry with python 3.13 performs the best on average for the import operation.</p>
<div id="fig-import" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-import-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="plot_import.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Benchmark result of poetry import operation"><img src="https://AnesBenmerzoug.github.io/posts/poetry-and-python-versions/plot_import.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-import-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Benchmark result of poetry import operation
</figcaption>
</figure>
</div>
<p>In Figure&nbsp;2, we can see that poetry with python 3.13 performs the best on average for the lock operation both with and without caching.</p>
<div id="fig-lock" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lock-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="plot_lock.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Benchmark result of poetry lock operation"><img src="https://AnesBenmerzoug.github.io/posts/poetry-and-python-versions/plot_lock.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lock-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Benchmark result of poetry lock operation
</figcaption>
</figure>
</div>
<p>In Figure&nbsp;3, we can see that poetry with python 3.11 performs the best on average for the install operation both with and without caching.</p>
<div id="fig-install" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-install-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="plot_install.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: Benchmark result of poetry install operation"><img src="https://AnesBenmerzoug.github.io/posts/poetry-and-python-versions/plot_install.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-install-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Benchmark result of poetry install operation
</figcaption>
</figure>
</div>
<p>In Figure&nbsp;4, we can see that poetry with python 3.13 performs the best on average for the update operation both with and without caching.</p>
<div id="fig-update" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-update-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="plot_update.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: Benchmark result of poetry update operation"><img src="https://AnesBenmerzoug.github.io/posts/poetry-and-python-versions/plot_update.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-update-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Benchmark result of poetry update operation
</figcaption>
</figure>
</div>
<p>In Figure&nbsp;5, we can see that poetry with python 3.11 and 3.13 perform similarily on average for the add package operation.</p>
<div id="fig-add" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-add-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="plot_add.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: Benchmark result of poetry add package operation"><img src="https://AnesBenmerzoug.github.io/posts/poetry-and-python-versions/plot_add.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-add-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Benchmark result of poetry add package operation
</figcaption>
</figure>
</div>
<p>As we can see from the results, python 3.13 without free threading does improve poetry’s performance on average in 3 out of the 5 operations (import, lock, update) both with and without caching. In the other 2 operations, the performance difference is minimal.</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>In conclusion, our little experiment has shown that Poetry with Python 3.13 performs better than Poetry with Python 3.11 and 3.12 on average in most cases. However the performance is not that significant, and it remains to be seen whether the experimental free threading feature would make a significant difference.</p>
<p>For now, I will keep on eye on Python 3.13 with free threading’s support for Poetry, and update my findings as more information becomes available. This experiment is just one of many possible tests of Poetry’s performance with different Python versions, and the results should be taken as a rough indication only as they may not necessarily reflect real-world use cases.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section></div> ]]></description>
  <guid>https://AnesBenmerzoug.github.io/posts/poetry-and-python-versions/</guid>
  <pubDate>Tue, 22 Oct 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>When ECR lifecycle policies are not enough…</title>
  <dc:creator>Anes Benmerzoug</dc:creator>
  <link>https://AnesBenmerzoug.github.io/posts/when-ecr-lifecycle-policies-are-not-enough/</link>
  <description><![CDATA[ 





<p>In this second post we will talk about something a bit different from last time. we will be using a tool to extend and take full advantage of <a href="https://aws.amazon.com/ecr/">ECR</a> <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/LifecyclePolicies.html">Lifecycle Policies</a> to prune more images than is possible with just lifecycle policies.</p>
<p>We will be using <a href="https://aws.amazon.com/">AWS</a>, a <a href="https://kubernetes.io/">Kubernetes</a> Cluster (self-hosted or <a href="https://aws.amazon.com/eks/">EKS</a>), as well as a <a href="https://en.wikipedia.org/wiki/Continuous_integration">Continuous Integration</a> system, or CI for short, to build and push images continously to ECR.</p>
<p>Let’s assume that we are continously building and pushing images to ECR after each push to the master branch. If we just keep doing that we will eventually hit <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/service-quotas.html">the maximum number of images in a given repository</a> and receive an error message for every subsequent push attempt.</p>
<p>In most cases, especially at the beginning of a project, there won’t be a problem because the maximum number of images per repository is quite high (the limit used to be 1000 <a href="https://aws.amazon.com/about-aws/whats-new/2019/07/amazon-ecr-now-supports-increased-repository-and-image-limits/">but was recently increased to 10000</a>).</p>
<p>For all other cases it is recommended to use ECR Lifecycle Policies to, at the very least, remove untagged images and prune very old images. But, once we start using them we quickly realize that the allowed rules are quite limited. For example we cannot currently remove all images with a certain tag prefix older than a certain number of days while keeping the last <strong>N</strong> even if they are too old.</p>
<p>Here are some examples of rules that cannot be created using them:</p>
<ul>
<li><p>Remove all images with a certain tag prefix that are older than a certain number of days while keeping the last <strong>N</strong> even if they are old:</p>
<p>This can happen if, for example, development stops on a certain project for some time i.e.&nbsp;no new images are being pushed but at the same time it is still deployed in production.</p></li>
<li><p>Keep all images in one repository that have a tag that already exists in a second repository:</p>
<p>This can happen if, for example, we have two different components i.e.&nbsp;two images that require the same version i.e.&nbsp;same tag to run properly.</p></li>
<li><p>Keep the last <strong>N</strong> images that were deployed to production and remove all other ones after some time:</p>
<p>This can happen if, for example, not all images that are pushed to ECR are used in production. It can because of errors in the <strong>Staging</strong> phase or security vulnerabilities, etc.</p></li>
</ul>
<p>In this post we will focus on solving the problem from the last example.</p>
<p>To do so we could either create our own service/tool to directly prune images and avoid using ECR Lifecycle Policies or we could complement it with a small service/tool that adds a given tag to certain images.</p>
<p>I went with the later and wrote a small service called <a href="https://github.com/AnesBenmerzoug/kube-ecr-tagger">kube-ecr-tagger</a> that runs inside the cluster and tags images for us.</p>
<p>Before presenting it, let’s have a look into ECR Lifecycle Policies a bit more in detail.</p>
<section id="ecr-lifecycle-policies" class="level2">
<h2 class="anchored" data-anchor-id="ecr-lifecycle-policies">ECR Lifecycle Policies</h2>
<p><a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/LifecyclePolicies.html">ECR lifecycle policies</a> are a part of ECR that enables us to specify the lifecycle management of images in a repository. A lifecycle policy, such as the following, is a set of one or more rules, where each rule defines an action for ECR. The actions apply to images that contain tags prefixed with the given strings. This allows the automation of cleaning up unused images, for example expiring images based on age or count:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"rules"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb1-3">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-4">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"rulePriority"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Expire images older than 14 days"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-6">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"selection"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-7">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tagStatus"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"untagged"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-8">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countType"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sinceImagePushed"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countUnit"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"days"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-10">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countNumber"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span></span>
<span id="cb1-11">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb1-12">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-13">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expire"</span></span>
<span id="cb1-14">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-15">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-16">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The allowed rules and actions are limited. For example, you cannot do any of the following:</p>
<ul>
<li>Match the same image with multiple rules ( this could be used to add exceptions to a rule ). If a rule matches an image it cannot be matched by another rule with a lower priority</li>
<li>Expire images both by count and by age</li>
<li>Choose to keep images that match a rule instead of expiring them</li>
<li>Match images with an exact tag, only tag prefixes are allowed</li>
</ul>
<p>To avoid some of these limitations and to solve our problem from the previous section I developed a simple tool called <a href="https://github.com/AnesBenmerzoug/kube-ecr-tagger">kube-ecr-tagger</a>.</p>
</section>
<section id="kube-ecr-tagger" class="level2">
<h2 class="anchored" data-anchor-id="kube-ecr-tagger">kube-ecr-tagger</h2>
<p><a href="https://github.com/AnesBenmerzoug/kube-ecr-tagger">kube-ecr-tagger</a> runs inside the cluster and tags the used ECR images in a given namespace, or in all namespaces, with either a given tag or a tag created by appending a unix timestamp to the passed tag prefix.</p>
<p>If a tag is passed then there will only be one such tag in each repository. If a tag prefix is passed instead then there will be multiple tags in each repository with the same prefix.</p>
<p>Let’s use a concrete example. Let’s assume that we use semantic versioning to tag our images in CI and that we are currently at version 1.0.X and that not all images that are pushed will be used in production. Perhaps some of them will fail in the acceptance/staging phase or be flagged for security issues if image scanning is activated.</p>
<p>We want to keep the last 100 images that are deployed in production and at the same time remove images whose tag starts with ‘1.0’ and that are older than 30 days. For that we could the following lifecycle policy:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"rules"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb2-3">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"rulePriority"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Keep last 100 images with tag prefix 'production' "</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-6">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"selection"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-7">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tagStatus"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tagged"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-8">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tagPrefixList"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"production"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-9">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countType"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imageCountMoreThan"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-10">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countNumber"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb2-11">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-12">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expire"</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-13">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-14">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-15">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"rulePriority"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-16">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Remove images with tag prefix '1.0' that are older than 30 days"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-17">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"selection"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-18">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tagStatus"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tagged"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-19">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tagPrefixList"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-20">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countType"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sinceImagePushed"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-21">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countNumber"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-22">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"countUnit"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"days"</span></span>
<span id="cb2-23">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb2-24">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expire"</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-25">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-26">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb2-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Then, in order to tag the images in production, which we assume for the sake of simplicity are deployed in the <strong>prod</strong> namespace, we will deploy kube-ecr-tagger as a Deployment in the <strong>kube-system</strong> namespace with the following example manifest:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apiVersion</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> apps/v1</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kind</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Deployment</span></span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metadata</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kube-ecr-tagger</span></span>
<span id="cb3-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">namespace</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kube-system</span></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spec</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">template</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spec</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">containers</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">         </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kube-ecr-tagger</span></span>
<span id="cb3-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">           </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> anesbenmerzoug/kube-ecr-tagger:latest </span></span>
<span id="cb3-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">           </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">command</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">           </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kube-ecr-tagger</span></span>
<span id="cb3-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">           </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">args</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">           </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> --namespace=prod</span></span>
<span id="cb3-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">           </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> --tag-prefix=production</span></span></code></pre></div>
<p>We should not forget to add a service account, if we’re using IAM roles for service accounts, or the right annotation, if we’re using <a href="https://github.com/uswitch/kiam">kiam</a> or <a href="https://github.com/jtblin/kube2iam">kube2iam</a>, with the right IAM permissions:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Version"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2012-10-17"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Statement"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb4-4">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-5">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Effect"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Allow"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-6">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb4-7">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetAuthorizationToken"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-8">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:BatchCheckLayerAvailability"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-9">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetDownloadUrlForLayer"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-10">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:DescribeImages"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-11">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:BatchGetImage"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-12">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:PutImage"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-13">            <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-14">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Resource"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*"</span></span>
<span id="cb4-15">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-16">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb4-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Example manifests can be found in the kube-ecr-tagger <a href="https://github.com/AnesBenmerzoug/kube-ecr-tagger">repository</a> under the <a href="https://github.com/AnesBenmerzoug/kube-ecr-tagger/tree/master/manifests">manifests</a> folder.</p>
<p>Once deployed, it will then check the ECR images of all deployed containers in the <strong>prod</strong> namespace and add tags with the prefix <strong>production</strong> to each image, if one does not exist already.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We have seen in this post that by combining a small tool with ECR Lifecycle Policies we can achieve more complicated rules than with plain lifecycle policies.</p>
<p>Of course, <a href="https://github.com/AnesBenmerzoug/kube-ecr-tagger">kube-ecr-tagger</a> is limited in what it can do but one can already have an idea of what can be achieved.</p>
<p>If you want to try kube-ecr-tagger you can simply use the built container images from <a href="https://hub.docker.com/r/anesbenmerzoug/kube-ecr-tagger">this repository</a> on Dockerhub.</p>
<p>I hope that you have learned at a thing or two from this post. If there are any mistakes or if you have questions please do not hesitate to reach out to me.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section></div> ]]></description>
  <guid>https://AnesBenmerzoug.github.io/posts/when-ecr-lifecycle-policies-are-not-enough/</guid>
  <pubDate>Tue, 28 Jul 2020 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Model Versioning with MLflow</title>
  <dc:creator>Anes Benmerzoug</dc:creator>
  <link>https://AnesBenmerzoug.github.io/posts/model-versioning-with-mlflow/</link>
  <description><![CDATA[ 





<p>In this very first post we will talk about machine learning model versioning and more specifically machine learning classifier versioning.</p>
<p>Of course, one could simply compare accuracies ( or whichever metric you’re using ) on a separate test set and promote whichever classifier has a better value but that does not offer us the same guarantees as statistical tests.</p>
<p>For example, one may train two different classifiers on the same dataset and get the following results on a separate test set:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>True Label</th>
<th>Model 1 Prediction</th>
<th>Model 2 Prediction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>A</td>
<td>B</td>
</tr>
<tr class="even">
<td>A</td>
<td>A</td>
<td>A</td>
</tr>
<tr class="odd">
<td>B</td>
<td>A</td>
<td>A</td>
</tr>
<tr class="even">
<td>A</td>
<td>A</td>
<td>B</td>
</tr>
<tr class="odd">
<td>A</td>
<td>B</td>
<td>B</td>
</tr>
<tr class="even">
<td>B</td>
<td>B</td>
<td>A</td>
</tr>
<tr class="odd">
<td>B</td>
<td>B</td>
<td>B</td>
</tr>
<tr class="even">
<td>B</td>
<td>A</td>
<td>B</td>
</tr>
<tr class="odd">
<td>A</td>
<td>A</td>
<td>A</td>
</tr>
<tr class="even">
<td>A</td>
<td>B</td>
<td>A</td>
</tr>
</tbody>
</table>
<p>We can see that the first classifier has an accuracy of 60% and the second classifier an accuracy of 50%. If we were to stop here we would just say that the first classifier is better than the second one and that could be true, but can this result be trusted?</p>
<p>To verify that we construct the following <a href="https://en.wikipedia.org/wiki/Confusion_matrix">confusion matrix</a>:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th>Model 2 Correct</th>
<th>Model 2 Wrong</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Model 1 Correct</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="even">
<td>Model 1 Wrong</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>By comparing the off-diagonal elements, we can intuitively know that there isn’t much of a difference between the two classifiers. To make that more precise we can use statistical tests instead of just comparing numbers.</p>
<p>One such test is <a href="https://en.wikipedia.org/wiki/McNemar%27s_test">McNemar’s Test</a>.</p>
<p>Before explaining McNemar’s Test and the different steps used to compare two machine learning classifiers, let’s first talk about <a href="https://mlflow.org/">MLflow</a>.</p>
<section id="mlflow" class="level2">
<h2 class="anchored" data-anchor-id="mlflow">MLFlow</h2>
<p><a href="https://mlflow.org/">MLflow</a> is an open source platform for the machine learning life-cycle. It is currently composed of four components:</p>
<ul>
<li><a href="https://www.mlflow.org/docs/latest/tracking.html">MLflow Tracking</a>: Used to record and query experiments: code, data, config, and results</li>
<li><a href="https://www.mlflow.org/docs/latest/projects.html">MLflow Projects</a>: Used to package data science code in a format to reproduce runs on any platform</li>
<li><a href="https://www.mlflow.org/docs/latest/models.html">MLflow Models</a>: Used to deploy machine learning models in diverse serving environments</li>
<li><a href="https://www.mlflow.org/docs/latest/model-registry.html">MLflow Model Registry</a>: Used to store, annotate, discover, and manage models in a central repository</li>
</ul>
<p>It uses a classic client server architecture as depicted in the following diagram:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    subgraph MLflow
        database[(Database)] &lt;--&gt; server(Server)
        storage[(Storage)] &lt;--&gt; server
    end

    server &lt;--&gt; client(Client)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The Client, user, interacts directly with the Server and the Server in turn interacts with the Database (MySQL, MSSQL, SQLITE, or POSTGRESQL) and the Storage backend (Local or Cloud).</p>
<p>In this post we’re only interested in the last component: the <a href="https://www.mlflow.org/docs/latest/model-registry.html"><strong>Model Registry</strong></a>.</p>
<p>It is a centralized model store, set of APIs, and UI, to collaboratively manage the full life-cycle of an MLflow Model. It provides model lineage (which MLflow experiment and run produced the model), model versioning, stage transitions (such as from staging to production), and annotations.</p>
<p>A registered model can be in any one of the following stages: - <strong>None</strong> - <strong>Staging</strong> - <strong>Production</strong> - <strong>Archived</strong></p>
<p>As can be seen in the following flowchart, a model starts, when first logged or registered, in the <strong>None</strong> stage and then transitions to the <strong>Staging</strong> stage, then to the <strong>Production</strong> stage and finally end its life-cycle in the <strong>Archived</strong> stage.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    none(None)
    staging(Staging)
    production(Production)
    archived(Archived)

    none --&gt; staging
    staging --&gt; production
    production --&gt; archived
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>For simplicity’s sake we won’t consider other possible transitions (e.g.&nbsp;<strong>Staging</strong> -&gt; <strong>Archived</strong>).</p>
<p>What the Model Registry does not take care of is automatically transition a given model to the appropriate stage and that is understandable because the conditions needed to do that depend on the actual application.</p>
</section>
<section id="mcnemars-test" class="level2">
<h2 class="anchored" data-anchor-id="mcnemars-test">McNemar’s test</h2>
<p>McNemar’s test is a non-parametric statistical test that can be used to compare two classification models by constructing a 2x2 contingency table, or confusion matrix, like the following:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th>Model 2 Correct</th>
<th>Model 2 Wrong</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Model 1 Correct</td>
<td>a</td>
<td>b</td>
</tr>
<tr class="even">
<td>Model 1 Wrong</td>
<td>c</td>
<td>d</td>
</tr>
</tbody>
</table>
<p>In order to test if there is a significant difference between the two models, we use only the off-diagonal elements, b and c, since the other elements tell us nothing about whether one model is better than the other or not.</p>
<p>McNemar’s test statistic is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AQ%20=%20%5Cfrac%7B(b%20-%20c)%7D%7Bb%20+%20c%7D%0A"></p>
<p>Which, for large values of b and c, follows a chi-squared distribution with 1 degree of freedom <img src="https://latex.codecogs.com/png.latex?%5Cchi_%7B1%7D%5E%7B2%7D">.</p>
<p>To more closely approximate the chi-squared distribution we can use the following definition instead which contains a continuity correction:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AQ%20=%20%5Cfrac%7B(%7Cb%20-%20c%7C%20-%201)%7D%7Bb%20+%20c%7D%0A"></p>
<p>If the result is significant, i.e.&nbsp;greater than a pre-defined significance level, usually set to 0.05 but can be changed depending on the use case, then we can conclude that the two models are significantly different from each other.</p>
<p>But it does not end there, we still have to determine which one of the two is better than the other one. For that, we can use one or a combination of the usual metrics: Accuracy, F-Score, False Positive Rate, etc.</p>
<p>If we apply the continuity corrected version of the test on our previous example we get as result <em>1.0</em> and can confidently say that there is no significant difference between the two classifiers.</p>
</section>
<section id="model-versioning-flow" class="level2">
<h2 class="anchored" data-anchor-id="model-versioning-flow">Model Versioning Flow</h2>
<p>Now that we have defined and explained all the required parts of the flow. We can assemble them into the following chart that shows the different steps taken to compare two different classification models:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    End--&gt;title["Model Versioning Flow Chart"]
    style title fill:#FFF,stroke:#FFF
    linkStyle 0 stroke:#FFF,stroke-width:0;
    Start((Start)) --&gt; A
    A(McNemar's Test) --&gt; B{"P-value &lt; &amp;alpha;"}
    B --&gt;|No| End((End))
    B --&gt;|Yes| C(Compute&lt;br&gt;Accuracies)
    C --&gt; D{Model1 Accuracy&lt;br&gt;&lt;&lt;br&gt;Model2 Accuracy}
    D --&gt;|No| End
    D --&gt;|Yes| E(Deploy Model2)
    E --&gt; End
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Here we use accuracy, but it could be replaced by other metrics such as False Positive Rate, False Negative Rate, etc.</p>
</section>
<section id="example" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<p>In <a href="https://github.com/AnesBenmerzoug/mlflow_model_versioning">this repository</a> you can find example code in Python that shows how to use the previous flow to do model versioning for machine learning classifiers with MLflow.</p>
<p>One important thing that should always be done is to pin the random seed to ensure the experiment’s repeatability.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">random_seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb1-2">np.random.seed(random_seed)</span></code></pre></div>
<p>In the example, we start off by generating artificial classification data using scikit-learn’s <a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.make_classification.html">make_classification</a> helper function and then splitting it into a training and a testing set:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">X, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_classification(</span>
<span id="cb2-2">        n_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>,</span>
<span id="cb2-3">        n_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb2-4">        n_features<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,</span>
<span id="cb2-5">        n_informative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,</span>
<span id="cb2-6">        random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>random_seed,</span>
<span id="cb2-7">)</span>
<span id="cb2-8">X_train, X_test, y_train, y_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(</span>
<span id="cb2-9">    X, y, train_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb2-10">)</span></code></pre></div>
<p>After that, we fit a Logistic Regression classifier, then register and log it into MLflow and finally move it to the <strong>Production</strong> phase:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> mlflow.start_run():</span>
<span id="cb3-2">    lr_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LogisticRegression()</span>
<span id="cb3-3">    lr_model.fit(X_train, y_train)</span>
<span id="cb3-4">    y_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lr_model.predict(X_test)</span>
<span id="cb3-5">    accuracy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb3-6">    mlflow.log_metric(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accuracy"</span>, accuracy)</span>
<span id="cb3-7">    mlflow.sklearn.log_model(</span>
<span id="cb3-8">        lr_model, artifact_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span>, registered_model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Logistic Regression"</span></span>
<span id="cb3-9">    )</span>
<span id="cb3-10"></span>
<span id="cb3-11">mlflow_client.transition_model_version_stage(</span>
<span id="cb3-12">    name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Logistic Regression"</span>, version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, stage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Production"</span></span>
<span id="cb3-13">)</span></code></pre></div>
<p>Then, we fit a Random Forest classifier, then register and log it into MLflow and finally move it to the <strong>Staging</strong> phase:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> mlflow.start_run():</span>
<span id="cb4-2">    rf_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RandomForestClassifier()</span>
<span id="cb4-3">    rf_model.fit(X_train, y_train)</span>
<span id="cb4-4">    y_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rf_model.predict(X_test)</span>
<span id="cb4-5">    accuracy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb4-6">    mlflow.log_metric(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accuracy"</span>, accuracy)</span>
<span id="cb4-7">    mlflow.sklearn.log_model(</span>
<span id="cb4-8">        rf_model, artifact_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span>, registered_model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Random Forest"</span></span>
<span id="cb4-9">    )</span>
<span id="cb4-10"></span>
<span id="cb4-11">mlflow_client.transition_model_version_stage(</span>
<span id="cb4-12">    name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Random Forest"</span>, version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, stage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Staging"</span></span>
<span id="cb4-13">)</span></code></pre></div>
<p>To simulate the fact that the model comparison may happen in another script we delete both trained model instances and load them back from MLflow:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> lr_model</span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> rf_model</span>
<span id="cb5-3"></span>
<span id="cb5-4">lr_model_download_uri <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mlflow_client.get_model_version_download_uri(</span>
<span id="cb5-5">    name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Logistic Regression"</span>, version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb5-6">)</span>
<span id="cb5-7">rf_model_download_uri <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mlflow_client.get_model_version_download_uri(</span>
<span id="cb5-8">    name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Random Forest"</span>, version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb5-9">)</span>
<span id="cb5-10">lr_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mlflow.sklearn.load_model(lr_model_download_uri)</span>
<span id="cb5-11">rf_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mlflow.sklearn.load_model(rf_model_download_uri)</span></code></pre></div>
<p>As a next step, we use both models to generate predictions on the test set. We use these predictions to compute each model’s accuracy and to create a contingency table that is finally used in a corrected version of McNemar’s Test to return a P-value:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">y_pred_lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lr_model.predict(X_test)</span>
<span id="cb6-2">y_pred_rf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rf_model.predict(X_test)</span>
<span id="cb6-3"></span>
<span id="cb6-4">accuracy_lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracy_score(y_test, y_pred_lr)</span>
<span id="cb6-5">accuracy_rf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracy_score(y_test, y_pred_rf)</span>
<span id="cb6-6"></span>
<span id="cb6-7">contingency_table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mcnemar_table(y_test, y_pred_lr, y_pred_rf)</span>
<span id="cb6-8">_, p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mcnemar(contingency_table, corrected<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<p>Finally we use the obtained P-value and the accuracies to decide whether we should deploy the Random Forest classifier to Production and archive the Logistic Regression classifier or not:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> significance <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> accuracy_lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> accuracy_rf:</span>
<span id="cb7-2">    mlflow_client.transition_model_version_stage(</span>
<span id="cb7-3">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Logistic Regression"</span>, version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, stage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Archived"</span>,</span>
<span id="cb7-4">    )</span>
<span id="cb7-5">    mlflow_client.transition_model_version_stage(</span>
<span id="cb7-6">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Random Forest"</span>, version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, stage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Production"</span>,</span>
<span id="cb7-7">    )</span></code></pre></div>
<p>We can then access the MLflow server’s dashboard and see that the Random Forest classifier’s version 1 is in Production and the Logistic Regression classifier’s version 1 was archived:</p>
<div class="page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="https://AnesBenmerzoug.github.io/posts/model-versioning-with-mlflow/mlflow_model_versioning_screenshot.png" class="img-fluid figure-img column-screen"></p>
<figcaption>MLflow Model Versioning Screenshot</figcaption>
</figure>
</div>
</div>
<p>All that’s left now is to run this or similar code either on a schedule or as part of a training workflow each time a new classifier is trained and logged.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We have seen that thanks to the Model Registry component of MLflow we can have a pretty simple automated model versioning flow for classifiers. This flow can be and should be extended and made more complete, depending on the use case. For example, by using a second metric for when a tie happens in the first one.</p>
<p>I hope that you have learned at a thing or two from this post. If there are any mistakes or if you have questions please do not hesitate to reach out to me.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section></div> ]]></description>
  <guid>https://AnesBenmerzoug.github.io/posts/model-versioning-with-mlflow/</guid>
  <pubDate>Wed, 08 Jul 2020 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
